<!doctype html>
<html lang="en">

<head>  
  
  <link rel="stylesheet"  type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>	
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-smart-table/2.1.6/smart-table.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
	
  <style>
	#marketsContainer tr.priceChangeUp td 
	{
	  background-color: #ceebd3 !important;
	  border-top: 1px double #27892f;
	  border-bottom: 1px double #27892f;
	  -webkit-transition-duration: 0.1s;
	  -moz-transition-duration: 0.1s;
	  transition-duration: 0.1s; 
	}
	
	#marketsContainer tr.priceChangeDown td 
	{
	  background-color: #f6d4d1 !important;
	  border-top: 1px double #c02a1d;
	  border-bottom: 1px double #c02a1d;
	  -webkit-transition-duration: 0.1s;
	  -moz-transition-duration: 0.1s;
	  transition-duration: 0.1s; 
	}
	.st-sort-ascent:before{
		content:'\25B2'
	}
	.st-sort-descent:before{
		content:'\25BC'
	}
  
  </style>
</head>

<body ng-app="myApp">
	<h1>Currencies Price Ticker</h1>
	<div class="container">
		<div class="row">
			<div class="col-xs-12 col-sm-6">
				<div id="marketsContainer" ng-controller="MainCtrl" ng-init="init()">
					<table id="table_btc" st-safe-src="btc_pcurrencies" st-table="displayPBTCCollection"   class="table table-striped">
						<thead>
							<tr>
								<th st-sort="name">Coin</th>
								<th st-sort="last">Price</th>
								<th st-sort="baseVolume">Volumne</th>
								<th st-sort="percentChange">Change</th>
								<th>Lowest Ask</th>
								<th>Hightest Bid</th>
							</tr>
							<tr>
								<th colspan="6">
									<input st-search="name"  class="form-control" type="search"/>
								</th>
							</tr>
						</thead>
						<tbody>
							<tr  ng-repeat="row in displayPBTCCollection" >
								<td>{{row.name | uppercase}}</td>
								<td>{{row.last}}</td>
								<td>{{row.baseVolume}}</td>
								<td ng-class="precentColor(row.percentChange)">{{row.percentChange}}</td>
								<td>{{row.lowestAsk}}</td>
								<td>{{row.highestBid}}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="col-xs-12 col-sm-6"></div>
		</div> 
	</div>
	
	  
</body>

</html>

<script>

var myApp = angular.module('myApp', ['smart-table']);


myApp.controller("MainCtrl", MainCtrl);
function MainCtrl($scope,socketio,$filter,commonService) {
	$scope.btc_pcurrencies=[];
	$scope.currencies=[];
	$scope.usdt_pcurrencies=[];
	
	$scope.startwithBTC="BTC_";
	$scope.startwithUSDT="USDT_";
	$scope.displayPBTCCollection = [];
	$scope.displayPUSDTCollection = [];
	$scope.init=function(){
		$scope.getPTicker();
	}
	
	$scope.pushToListCurrenices=function(currency){
					
		if(currency.currencyPair.startsWith($scope.startwithBTC)){
			console.log("BTC");					
			$scope.updateTicker(currency,$scope.btc_pcurrencies);
			$scope.displayPBTCCollection=$scope.btc_pcurrencies;
		}else if(currency.currencyPair.startsWith($scope.startwithUSDT)){
			console.log("USDT");			
			$scope.updateTicker(currency,$scope.usdt_pcurrencies);	
			$scope.displayPUSDTCollection=$scope.usdt_pcurrencies;			
		}	
	}
	
	$scope.buildCurrencyObject=function(value, key){
		
		if(key.startsWith($scope.startwithBTC)){
			value.name=key.replace($scope.startwithBTC,"");				
		}else{
			value.name=key.replace($scope.startwithUSDT,"");
		}
		value.currencyPair=key;
			
		return value;
	}
	
	$scope.getPTicker=function(){
		var url='/getPTicker';
		commonService.ajaxRequest(url).then(function(response){			
			var data = JSON.parse(response.data);
			angular.forEach(data, function(value,key){
				currency=$scope.buildCurrencyObject(value,key);
				$scope.pushToListCurrenices(currency);				
			});
			//$scope.displayPBTCCollection= [].concat($scope.btc_pcurrencies);
		},function(error){
			console.log(error);
		})
	}
	
	$scope.updateTicker=function(data,currencies){
	
		var found = $filter('filter')(currencies, {currencyPair: data.currencyPair}, true);
		if(found.length){			
			$scope.updatePrice(data,currencies);			
		}else{
			console.log("New");
			currencies.push(data);
		}
		
	}
	$scope.updatePrice=function(data,currencies){
		//update price
		angular.forEach(currencies, function(c, i) {
          if (c.currencyPair === data.currencyPair ) {
            currencies[i] = data;
			if(c.currencyPair.startsWith($scope.startwithBTC)){
				$scope.highlight('table_btc',i);
			}else{
				$scope.highlight('table_btc',i);
			}	
          }
        });
	}
	
	$scope.highlight= function(id,index){
		var table=document.getElementById(id);
		row = table.find('tr').eq(index);
		console.log(row);
	}
	
	
	
	$scope.precentColor=function(value){
		if(parseFloat(value)>0){
			return "text-success";
		}else{
			return "text-danger";
		}
	}
	
    socketio.on('connect', function () {
	    console.log("Connected");	
    });
	
    socketio.on('messages', function(data) {		
		var currency={};
		currency.currencyPair=data[0];
		currency.last=data[1];
		currency.baseVolume=data[5];
		currency.percentChange=data[4];
		currency.lowestAsk=data[2];
		currency.highestBid=data[3];
		
		if(data[0].startsWith($scope.startwithBTC)){
			currency.name=data[0].replace($scope.startwithBTC,"");				
		}else{
			currency.name=data[0].replace($scope.startwithUSDT,"");
		}
		$scope.pushToListCurrenices(currency);			
				        
    });
	
    socketio.on('disconnect', function() {
            console.log("Disconnected");    
    });		
	
	
}
myApp.factory('socketio', function ($rootScope) {
    var socket = io.connect();
    return {
        on: function (eventName, callback) {
            socket.on(eventName, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    callback.apply(socket, args);
                });
            });
        },
        emit: function (eventName, data, callback) {
            socket.emit(eventName, data, function () {
                var args = arguments;
                $rootScope.$apply(function () {
                    if (callback) {
                        callback.apply(socket, args);
                    }
                });
            })
        }
    };
});
myApp.factory('commonService',['$http',function($http){
	return{
		ajaxRequest: function(url){
			return $http({
			  method: 'POST',
			  url: url
			});
		}
	}
}])

	        
</script>

 
